# otus_dp_pg
урок по созданию бэкапа и восстановлению из него.

# Создание виртуальной машины
- зашел на console.cloud.yandex.ru
- создал платежный аккаунт
- привязал к нему  виртуальную карту
- создал виртуальную машину. 
- для связи использовал сгенерированный rsa ключ
машина создалась для убунты 22
  ssh -i ~/.ssh/yc_key otus@158.160.29.167
- ![тест1 ](../picture/lesson_01/p0.png)

## Вторая часть ДЗ

- подключился к виртуальной машине 
  установил постгресс:
  sudo apt update && sudo DEBIAN_FRONTEND=noninteractive apt upgrade -y -q && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt -y install postgresql-15
  обновляются пакеты линукса
  ![установка](../picture/lesson_05/p01.png)

- установка pg_probackup
  ![установка](../picture/lesson_05/p02.png)

- помучавшись со скриптами, наконец выполняю скрипт для инициализации pg_probackup и инциализирую каталог хранения
  ![установка](../picture/lesson_05/p03.png)
- проверил что каталоги создались
  ![производительность](../picture/lesson_05/p04.png)
- проверим конфигурацию
  ![производительность](../picture/lesson_05/p05.png)
- запустил первый полный бэкап
  ![узнал свободную память](../picture/lesson_05/p06.png)

  указано, что не включена контрольная сумма
- включил контрольную сумму
  ![настройка](../picture/lesson_05/p07.png)
- проверил что бэкап появился
  ![настройка](../picture/lesson_05/p08.png)
- делаем настройку для отключения запроса пароля при фоновом формировании бэкапа, заодно добавлю бд 
  ![настройка](../picture/lesson_05/p09.png)

- при добавлении новой бд необходимо предоставлять права
  ![настройка](../picture/lesson_05/p10.png)
  прописал права на подключение
  ![настройка](../picture/lesson_05/p12.png)
  ![настройка](../picture/lesson_05/p11.png)
  проверил права
- сделал бэкап с дополнительной бд
  ![настройка](../picture/lesson_05/p13.png)
- однако все еще требует пароль, хотя прописано
  ![настройка](../picture/lesson_05/p14.png)
  сделал не тривиальную настройку пароля. Вспомнил что ментор говорил на лекции, тогда не удивило, сейчас поразило.
  ![настройка](../picture/lesson_05/p15.png)
  удивительно, но пароль больше не просит. Страннный артефакт
  ![настройка](../picture/lesson_05/p14.png)
- получил список бэкапов
  ![настройка](../picture/lesson_05/p16.png)
- делаю восстановление бэкапа на второй кластер
  ![настройка](../picture/lesson_05/p17.png)
- проверяю что бэкап успешно восстановился
  ![настройка](../picture/lesson_05/p18.png)
 
 
общие замечания:
1. делать нужно внимательно. Малейшая ошибка и ничего не работает. 
2. сообщения не всегда информативны.
3. что приводит в замешательство - наличие странных артефактов.
4. очень жесткая привязка сценариев к версии бд

Машину после использования положил
